@using System.App.Model.Enums
@using System.App.Model.Consts
@using System.App.Model.Resources
@using System.App.Web.TraineR.Models.Domain
@using Newtonsoft.Json
@using System.App.Utility.Helpers

@{
    //
    // SELECT name, COUNT(*) FROM image GROUP BY name HAVING COUNT(*) > 1
    // 现存207张同时关联多个病人或就诊的图片，需人工处理

    // 
    // FIRST CREATE IDX_IMAGE_NAME to speed up

    var db = new NewbornContainer();

    //foreach (var img in db.Image.Where(x => x.Name == "0001.jpg"))
    // {
    //    img.Name = img.ImageFilePath;
    //}


    //foreach (var img in db.Image.Where(x => x.Name =="欧堡全景"
    //|| x.Name == "智诠眼底照相"
    //|| x.Name == "验光"
    //|| x.Name == "人工晶体度数测量"
    //|| x.Name == "检查报告扫描"
    //|| x.Name == "角膜地形图"))
    //{
    //    img.Type = img.Name;
    //    img.Name = img.ImageFilePath;
    //}

    var names = db.Image.GroupBy(x => x.Name, (k, v) => new { key = k, c = v.Count() }).
        Where(x => x.c > 1).Select(x => x.key).ToList();

    int batch = 100;

    foreach (var name in names)
    {
        bool skip_first = true;
        string first_path = null;
        string first_type = null;
        Image first = null;

        foreach (var img in db.Image.Where(x => x.Name == name)
            .OrderByDescending(x=>x.Visit.VisitId))
        {
            if (skip_first)
            {
                first_path = img.ImageFilePath;
                first_type = img.Type;
                first = img;
                skip_first = false;
            }
            else
            {
                //if (img.ImageFilePath == first_path
                //    && img.Type == first_type)
                //{
                //    db.Image.Remove(img);
                //}
                //else
                {
                    if(first.Visit!=null && img.Visit==null)
                    {
                        if(img.Comment != null && img.Comment != "")
                        {
                            first.Comment += "\n" + img.Comment;
                        }

                        if(img.Description!=null && img.Description!="")
                        {
                            first.Description += "\n" + img.Description;
                        }

                        db.Image.Remove(img);
                    }
                    else if(first.Visit != null && img.Visit == first.Visit)
                    {
                        if (img.ImageFilePath == first.ImageFilePath
                            && img.Type == first.Type)
                        {
                            db.Image.Remove(img);
                        }
                    }
                }
            }
        }

        if (batch-- < 0)
        {
            db.SaveChanges();
            db = new NewbornContainer();

            batch = 100;
        }
    }

    db.SaveChanges();
}